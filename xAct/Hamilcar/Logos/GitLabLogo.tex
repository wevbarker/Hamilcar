\documentclass[tikz]{standalone}
\usepackage{tikz}
\usetikzlibrary{3d}
\usepackage{etoolbox}
\usepackage{tensor}
\usepackage{xspace}
\usepackage{amsmath}
\usepackage[dvipsnames]{xcolor}
\input{Macros.tex}
\input{MacrosNames.tex}
\begin{document}
\begin{tikzpicture}[
    x={(1cm,0cm)},
    y={(0.4cm,0.3cm)},
    z={(0cm,1cm)}
]
% Square bounding box
\path[use as bounding box] (-0.3cm,-0.3cm) rectangle (5.3cm,5.3cm);

% Foliated spacetime block - 3D (right figure only)
\def\nslices{3}
\def\cubesize{3}
\def\xsize{\cubesize}
\def\ysize{\cubesize}
\def\zsize{\cubesize}
\pgfmathsetmacro{\sliceheight}{\zsize/\nslices}
\def\curvature{0.12}

% Bounding cube
\pgfmathsetmacro{\zmax}{\nslices*\sliceheight}

% Annular Gaussian parameters (origin at sheet center)
\def\maxringradius{1.0}
\def\minsigma{0.2}
\def\maxsigma{0.6}
\def\maxamplitude{1.0}
\def\minamplitude{0.4}
\def\patchsize{0.15}
% Spiral modulation: r0 -> r0 + spiralamp * sin(spiralarms * theta + spiralradial * r)
\def\spiralamp{0.5}
\def\spiralarms{5}
\def\spiralradial{6}

% Vertical faces - plain
\fill[blue!5, opacity=0.3] (0, 0, 0) -- (\xsize, 0, 0) -- (\xsize, 0, \zmax) -- (0, 0, \zmax) -- cycle;
\fill[blue!5, opacity=0.3] (\xsize, 0, 0) -- (\xsize, \ysize, 0) -- (\xsize, \ysize, \zmax) -- (\xsize, 0, \zmax) -- cycle;
\fill[blue!5, opacity=0.2] (0, \ysize, 0) -- (\xsize, \ysize, 0) -- (\xsize, \ysize, \zmax) -- (0, \ysize, \zmax) -- cycle;
\fill[blue!5, opacity=0.2] (0, 0, 0) -- (0, \ysize, 0) -- (0, \ysize, \zmax) -- (0, 0, \zmax) -- cycle;

% Vertical edges
\draw[black!50, thick, dashed] (0, \ysize, 0) -- (0, \ysize, \zmax);
\draw[black!50, thick] (\xsize, 0, 0) -- (\xsize, 0, \zmax);
\draw[black!50, thick] (0, 0, 0) -- (0, 0, \zmax);
\draw[black!50, thick] (\xsize, \ysize, 0) -- (\xsize, \ysize, \zmax);

% All slices
\foreach \i in {0,...,\nslices} {
    \pgfmathsetmacro{\zbase}{\i*\sliceheight}
    \pgfmathsetmacro{\tfrac}{\i/\nslices}
    % Radius grows from 0 to maxringradius
    \pgfmathsetmacro{\ringradius}{\tfrac*\maxringradius}
    % Sigma grows from minsigma to maxsigma
    \pgfmathsetmacro{\ringsigma}{\minsigma + \tfrac*(\maxsigma - \minsigma)}
    % Amplitude decreases from maxamplitude to minamplitude
    \pgfmathsetmacro{\amplitude}{\maxamplitude - \tfrac*(\maxamplitude - \minamplitude)}

    % Draw colored patches
    \foreach \xx in {0,\patchsize,...,\xsize} {
        \foreach \yy in {0,\patchsize,...,\ysize} {
            % Coordinates relative to center
            \pgfmathsetmacro{\cx}{\xx - \xsize/2}
            \pgfmathsetmacro{\cy}{\yy - \ysize/2}
            \pgfmathsetmacro{\rr}{sqrt(\cx*\cx + \cy*\cy)}
            \pgfmathsetmacro{\thetadeg}{atan2(\cy, \cx)}
            % Spiral-modulated ring radius
            \pgfmathsetmacro{\rmod}{\ringradius + \spiralamp*sin(\spiralarms*\thetadeg + \spiralradial*\rr*180/3.14159)}
            % Annular Gaussian: amplitude * exp(-((r - r0)/sigma)^2)
            \pgfmathsetmacro{\gaussval}{\amplitude*exp(-((\rr - \rmod)/\ringsigma)^2)}
            % Interpolate between 15 (pale blue) and 100 (full blue)
            \pgfmathsetmacro{\colval}{15 + \gaussval*85}

            % Corner heights (clamp to boundary)
            \pgfmathsetmacro{\z}{\zbase + \curvature*sin(\xx*180/\xsize) + \curvature*sin(\yy*180/\ysize)}
            \pgfmathsetmacro{\xxp}{min(\xx + \patchsize, \xsize)}
            \pgfmathsetmacro{\yyp}{min(\yy + \patchsize, \ysize)}
            \pgfmathsetmacro{\zxp}{\zbase + \curvature*sin(\xxp*180/\xsize) + \curvature*sin(\yy*180/\ysize)}
            \pgfmathsetmacro{\zyp}{\zbase + \curvature*sin(\xx*180/\xsize) + \curvature*sin(\yyp*180/\ysize)}
            \pgfmathsetmacro{\zxyp}{\zbase + \curvature*sin(\xxp*180/\xsize) + \curvature*sin(\yyp*180/\ysize)}

            \fill[blue!\colval, opacity=0.7]
                (\xx, \yy, \z) -- (\xxp, \yy, \zxp) -- (\xxp, \yyp, \zxyp) -- (\xx, \yyp, \zyp) -- cycle;
        }
    }

    % Front edge (y=0)
    \draw[black!60, thick] (0, 0, \zbase)
        \foreach \xx in {0,0.1,...,\xsize} {
            -- (\xx, 0, {\zbase + \curvature*sin(\xx*180/\xsize)})
        };

    % Right edge (x=xsize)
    \draw[black!60, thick] (\xsize, 0, {\zbase + \curvature*sin(180)})
        \foreach \yy in {0,0.1,...,\ysize} {
            -- (\xsize, \yy, {\zbase + \curvature*sin(180) + \curvature*sin(\yy*180/\ysize)})
        };

    % Back edge (y=ysize)
    \draw[black!40, thick] (0, \ysize, {\zbase + \curvature*sin(180)})
        \foreach \xx in {0,0.1,...,\xsize} {
            -- (\xx, \ysize, {\zbase + \curvature*sin(\xx*180/\xsize) + \curvature*sin(180)})
        };

    % Left edge (x=0)
    \draw[black!40, thick] (0, 0, \zbase)
        \foreach \yy in {0,0.1,...,\ysize} {
            -- (0, \yy, {\zbase + \curvature*sin(\yy*180/\ysize)})
        };
}

% Two small black holes above foliation
\pgfmathsetmacro{\spherezpos}{\zmax + 1.0}
\node[circle, fill=black, inner sep=3.5pt] (leftbh) at (\xsize/2 - 0.25, \ysize/2, \spherezpos) {};
\node[circle, fill=black, inner sep=2.5pt] (rightbh) at (\xsize/2 + 0.25, \ysize/2, \spherezpos + 0.2) {};
% Curved arrows showing orbital motion
\draw[<-, thick] (leftbh) to[out=160, in=160, looseness=1.7] (rightbh);
\draw[<-, thick] (rightbh) to[out=-20, in=-20, looseness=1.7] (leftbh);

% x and y axes on bottom edges
\pgfmathsetmacro{\xext}{\xsize + 0.6}
\pgfmathsetmacro{\yext}{\ysize + 1.0}
\draw[->, very thick] (0, 0, 0)
    \foreach \xx in {0,0.1,...,\xext} {
        -- (\xx, 0, {\curvature*sin(\xx*180/\xsize)})
    } node[right] {\sffamily\bfseries x};
\draw[->, very thick] (\xsize, 0, {\curvature*sin(180)})
    \foreach \yy in {0,0.1,...,\yext} {
        -- (\xsize, \yy, {\curvature*sin(180) + \curvature*sin(\yy*180/\ysize)})
    } node[above] {\sffamily\bfseries y};

% Time arrow
\draw[->, very thick] (\xsize, \ysize, 0) -- (\xsize, \ysize, \nslices*\sliceheight + 0.5) node[above] {\sffamily\bfseries t};

\end{tikzpicture}
\end{document}
